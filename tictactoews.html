<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Documento sin título</title>
<link rel="stylesheet" href=" https://bootswatch.com/paper/bootstrap.min.css">
    <style>
    .pieza{border: 1px solid #e0e0e0;width: 70px;height:70px;margin-left: 15px;margin-right: 15px;}
        .pieza[value="x"]{color: #ffffff;background-color: #4caf50;}
        .pieza[value="o"]{ color: #ffffff;background-color: #9c27b0;}
        .ganador{border: 1px solid #e0e0e0;width: 70px;height:70px;margin-left: 15px;margin-right: 15px;}
        .ganador[value="x"]{color: #ffffff;background-color: #4caf50;}
        .ganador[value="o"]{ color: #ffffff;background-color: #9c27b0;}
        
    </style>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://bootswatch.com/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    
</head>
<body>
   <div class="container">
       <div class="row ">
           <div class="col-md-3">
              
           </div>
           <div class="col-md-6 text-center">
               <h4>Tic Tac Toe (Gato)</h4>
           </div>
           <div class="col-md-3"></div>
       </div>
       <div class="row ">
           <div class="col-md-3"></div>
           <div class="col-md-6 text-center">
               <div id="tictactoe"></div>
           </div>
           <div class="col-md-3"></div>
       </div>

      </div> 
<script>

var turno="o";
var cantidadOpciones=3;
var posicion;

var ws = new WebSocket('ws://achex.ca:4010');
ws.onopen= function(evt){ws.send('{"setID":"oscaruh","passwd":"123"}');};   
ws.onmessage = function(evt){
    var info= evt.data;
    var obj = jQuery.parseJSON(info);  
    if(obj.turno!=null){
        
        turno=obj.turno; $('#turnoDisplay').val(turno);
    }
    if(obj.Movimientos!=null){
        $.each(obj.Movimientos, function (key, data) {
            $("#"+data.id).val(data.valor);
        });
    }
    cotejar();
    turno=(turno=="o")?"x":"o";

};
crearAlerta();
crearBotones();

$( ".pieza" ).click(function() {
    $(this).val(turno); 
    recolectarInfo();
});
    
function cotejar(){
        for(i=1;i<=cantidadOpciones;i++){
	    for(j=1;j<=cantidadOpciones;j++){
        fila=i;
        columna=j;
        contadorTotalFilas=1;
		contadorTotalcolumnas=1;
		contadorDiagonal=1;
		contadorDiagonalInversa=1;
		contadorTurnos=0;
        $( ".pieza" ).each(function( index ) {
		    elid=$( this ).attr('id');
		
            if((elid.charAt(0)==fila)&&($( this ).val()==turno)){
                contadorTotalFilas++;	
                if(contadorTotalFilas==(cantidadOpciones+1)){campeon();	}
            }
            
            if((elid.charAt(1)==columna)&&($( this ).val()==turno)){
                contadorTotalcolumnas++;	
                if(contadorTotalcolumnas==(cantidadOpciones+1))	{campeon();}
            }
            if((elid.charAt(1)==elid.charAt(0))&&($( this ).val()==turno)){
                contadorDiagonal++;
			    if(contadorDiagonal==(cantidadOpciones+1)){campeon();}
            }
		  valorTotaldiagonal= parseInt(elid.charAt(1))+parseInt(elid.charAt(0));
		    if(((valorTotaldiagonal)==(cantidadOpciones+1)) &&($( this ).val()==turno)){
			     contadorDiagonalInversa++;
		          if(contadorDiagonalInversa==(cantidadOpciones+1)){campeon();	}
            }
            if($(this).val()!="-"){contadorTurnos++;
                if(contadorTurnos==(cantidadOpciones*cantidadOpciones)){TerminarJuego();}
            }
            
        });
        }
    }
	}
    function TerminarJuego(){
        $("#alertMensaje").html("Juego terminado");
        $(".alert").show('slow');
        $( "#iniciar" ).removeClass( "disabled" );
    }
    function Reiniciar(){
         $(".alert").hide('slow');
        contadorTotalFilas=1;
		contadorTotalcolumnas=1;
		contadorDiagonal=1;
		contadorDiagonalInversa=1;
		contadorTurnos=0;
        $( ".pieza" ).each(function( index ) {
            $( this ).val('-');
        
        });
        
        $( "#iniciar" ).addClass( "disabled" );
        
    }
    function campeon(){
        $("#alertMensaje").html('Ganador <strong><input class="ganador btn btn-primary btn-lg" type="button" value="'+turno+'"></strong>');
        $(".alert").show('slow');
        $( "#iniciar" ).removeClass( "disabled" );
    }
    function cerrarAlert(){
        $(".alert").hide('slow');
        $( "#iniciar" ).removeClass( "disabled" );
        Reiniciar();
    }
    function crearAlerta(){
     $("#tictactoe").append('<div class="alert alert-dismissible alert-warning collapse"><button type="button" class="close" onclick="cerrarAlert()">×</button><div id="alertMensaje"></div></div>');
    }
    function crearBotones(){
    for(i=1;i<=cantidadOpciones;i++){
	for(j=1;j<=cantidadOpciones;j++){
		  $("#tictactoe").append( "<input class='pieza btn btn-primary btn-lg' type='button' value='-' id='"+i+j+"'/>" );
	   }$("#tictactoe").append( "<hr style='  margin: 7px;'/>" );
    }$("#tictactoe").append('<br/>');
         $("#tictactoe").append('<span class=" well"><strong>Turno:</strong> <input class="btn btn-warning" id="turnoDisplay" type="button" value="o"></span>');
         $("#tictactoe").append('<br/>');
        $("#tictactoe").append('<br/>');
      
    $("#tictactoe").append('<input type="button" id="iniciar" onclick="Reiniciar()" value="Reiniciar" class="btn btn-danger btn-lg disabled"/>');

       
        
    }
    function recolectarInfo(){
      jsonObj = [];
      $( ".pieza" ).each(function( index ) {
        var id = $(this).attr("id");
        var valor = $(this).val();
        item = {}
        item ["id"] = id;
        item ["valor"] = valor;
        jsonObj.push(item);
    });
        ws.send('{"to":"oscaruh","turno":"'+turno+'","posicion":"'+posicion+'","Movimientos":'+JSON.stringify(jsonObj)+'}');
    }

</script>
</body>
</html>
